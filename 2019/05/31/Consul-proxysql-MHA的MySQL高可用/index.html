<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Consul+proxysql+MHA的MySQL高可用 | IT百晓生</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.0/jquery.min.js"></script><link rel="icon" mask sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Consul+proxysql+MHA的MySQL高可用</h1><a id="logo" href="/.">IT百晓生</a><p class="description">取之开源，分享开源。learn share</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Consul+proxysql+MHA的MySQL高可用</h1><div class="post-meta">May 31, 2019<span> | </span><span class="category"><a href="/categories/DB/">DB</a></span></div><div class="post-content"><h1 id="Consul-proxy-SQL-MHA实现MySQL读写分离及高可用"><a href="#Consul-proxy-SQL-MHA实现MySQL读写分离及高可用" class="headerlink" title="Consul+proxy SQL+MHA实现MySQL读写分离及高可用"></a>Consul+proxy SQL+MHA实现MySQL读写分离及高可用</h1><h2 id="一、Consul"><a href="#一、Consul" class="headerlink" title="一、Consul"></a>一、Consul</h2><h3 id="1、Consul介绍"><a href="#1、Consul介绍" class="headerlink" title="1、Consul介绍"></a>1、Consul介绍</h3><p>Consul 是 service mesh(服务网格)的一个解决方案，它提供了诸如服务发现，配置和隔离等功能的一整套控制平面(control plane)。<br>Consul 的核心功能如下：</p>
<ol>
<li>多数据中心服务发现（DNS+HTTP）</li>
<li>支持健康检查</li>
<li>但数据中心为服务</li>
<li>内置WebUI，用于编辑Key/Value和查看健康检查状态</li>
<li>支持热配置，不用重启服务</li>
<li>支持编排任务</li>
</ol>
<p>###官方架构</p>
<p><img src="https://i.imgur.com/0GOvhl1.png" alt></p>
<ol>
<li>Consul Cluster由部署和运行了Consul Agent的节点组成。在Cluster中有两种角色：Server和Client。</li>
<li>Server和Client的角色和Consul Cluster上运行的应用服务无关，是基于Consul层面的一种角色划分。</li>
<li>Consul Server：用于维护Consul Cluster的状态信息，实现数据一致性，响应RPC请求。</li>
<li>Consul Client：只维护自身的状态，并将HTTP和DNS接口请求转发给服务端</li>
<li>Consul支持多数据中心，多个数据中心要求每个数据中心都要安装一组Consul cluster，多个数据中心间基于gossip protocol协议来通讯，使用Raft算法实现一致性</li>
</ol>
<blockquote>
<p>官方建议是：至少要运行3个或者3个以上的Consul Server。多个server之中需要选举一个leader，这个选举过程Consul基于Raft协议实现。多个Server节点上的Consul数据信息保持强一致性。在局域网内与本地客户端通讯，通过广域网与其他数据中心通讯</p>
</blockquote>
<h3 id="2、环境准备"><a href="#2、环境准备" class="headerlink" title="2、环境准备"></a>2、环境准备</h3><table>
<thead>
<tr>
<th>IP</th>
<th>OS</th>
<th>HOSTNAME</th>
<th>service</th>
<th style="text-align:center">VERSION</th>
</tr>
</thead>
<tbody>
<tr>
<td>192.168.2.6</td>
<td>CentOS7.6</td>
<td>node6.timeser.com</td>
<td>consul-server</td>
<td style="text-align:center">consul1.4.4v</td>
</tr>
<tr>
<td>192.168.2.45</td>
<td>CentOS7.6</td>
<td>node45.timeser.com</td>
<td>consul-server</td>
<td style="text-align:center">consul1.4.4v</td>
</tr>
<tr>
<td>192.168.2.95</td>
<td>CentOS7.6</td>
<td>node95.timeser.com</td>
<td>consul-server</td>
<td style="text-align:center">consul1.4.4v</td>
</tr>
<tr>
<td>192.168.2.7</td>
<td>CentOS7.6</td>
<td>node7.timeser.com</td>
<td>proxysql、consul-client、mha-manager</td>
<td style="text-align:center">consul1.4.4v</td>
</tr>
<tr>
<td>192.168.1.115</td>
<td>CentOS7.6</td>
<td>node115.timeser.com</td>
<td>MySQL-master、proxysql、consul-client</td>
<td style="text-align:center">consul1.4.4v</td>
</tr>
<tr>
<td>192.168.1.110</td>
<td>CentOS7.6</td>
<td>node110.timeser.com</td>
<td>MySQL-slave、consul-clent</td>
<td style="text-align:center">consul1.4.4v</td>
</tr>
<tr>
<td>192.168.1.44</td>
<td>CentOS7.6</td>
<td>node44.timeser.com</td>
<td>MySQL-slave、consul-client</td>
<td style="text-align:center">consul1.4.4v</td>
</tr>
<tr>
<td>192.168.2.136</td>
<td>CentOS7.6</td>
<td>node136.timeser.com</td>
<td>application</td>
<td style="text-align:center">-</td>
</tr>
</tbody>
</table>
<h3 id="3、Consul-安装"><a href="#3、Consul-安装" class="headerlink" title="3、Consul 安装"></a>3、Consul 安装</h3><p>全程使用ansible安装</p>
<ul>
<li><p>目录结构</p>
  <figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@node7 consul]<span class="comment"># tree /etc/consul.d/</span></span><br><span class="line"></span><br><span class="line"><span class="regexp">/etc/consul.d/</span></span><br><span class="line">├── client.json</span><br><span class="line">├── proxysql.json</span><br><span class="line">└── scripts</span><br><span class="line">    └── proxysql_check.sh</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> directory, <span class="number">3</span> files</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="4、配置文件"><a href="#4、配置文件" class="headerlink" title="4、配置文件"></a>4、配置文件</h3><ul>
<li><p>consul server配置文件</p>
<p>  advertise_addr(主机IP)和node_name(主机名)，（node6、node45、node95）三个主机修改对应的信息<br>  “domain”:’timeser’,所以集群域名是：service.timeser</p>
  <figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@node6</span> ~]<span class="meta"># cat /etc/consul.d/server.json </span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"addresses"</span>:&#123;</span><br><span class="line">        <span class="string">"http"</span>:<span class="string">"0.0.0.0"</span>,</span><br><span class="line">        <span class="string">"dns"</span>:<span class="string">"0.0.0.0"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"bind_addr"</span>:<span class="string">"0.0.0.0"</span>,</span><br><span class="line">    <span class="string">"advertise_addr"</span>:<span class="string">"192.168.2.6"</span>,</span><br><span class="line">    <span class="string">"bootstrap_expect"</span>:<span class="number">3</span>,</span><br><span class="line">    <span class="string">"datacenter"</span>:<span class="string">"dc1"</span>,</span><br><span class="line">    <span class="string">"data_dir"</span>:<span class="string">"/data/consul"</span>,</span><br><span class="line">    <span class="string">"dns_config"</span>:&#123;</span><br><span class="line">        <span class="string">"allow_stale"</span>:<span class="literal">true</span>,</span><br><span class="line">        <span class="string">"max_stale"</span>:<span class="string">"87600h"</span>,</span><br><span class="line">        <span class="string">"node_ttl"</span>:<span class="string">"0s"</span>,</span><br><span class="line">        <span class="string">"service_ttl"</span>:&#123;</span><br><span class="line">            <span class="string">"*"</span>:<span class="string">"0s"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"domain"</span>:<span class="string">"timeser"</span>,</span><br><span class="line">    <span class="string">"enable_syslog"</span>:<span class="literal">false</span>,</span><br><span class="line">    <span class="string">"leave_on_terminate"</span>:<span class="literal">false</span>,</span><br><span class="line">    <span class="string">"log_level"</span>:<span class="string">"info"</span>,</span><br><span class="line">    <span class="string">"node_name"</span>:<span class="string">"node6.timeser.com"</span>,</span><br><span class="line">    <span class="string">"node_meta"</span>:&#123;</span><br><span class="line">        <span class="string">"location"</span>:<span class="string">"timeser"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"performance"</span>:&#123;</span><br><span class="line">        <span class="string">"raft_multiplier"</span>:<span class="number">1</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"ports"</span>:&#123;</span><br><span class="line">        <span class="string">"http"</span>:<span class="number">8500</span>,</span><br><span class="line">        <span class="string">"dns"</span>:<span class="number">53</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"reconnect_timeout"</span>:<span class="string">"72h"</span>,</span><br><span class="line">    <span class="string">"recursors"</span>:[</span><br><span class="line">        <span class="string">"114.114.114.114"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"retry_join"</span>:[</span><br><span class="line">        <span class="string">"192.168.2.6"</span>,</span><br><span class="line">        <span class="string">"192.168.2.45"</span>,</span><br><span class="line">        <span class="string">"192.168.2.95"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"retry_interval"</span>:<span class="string">"10s"</span>,</span><br><span class="line">    <span class="string">"server"</span>:<span class="literal">true</span>,</span><br><span class="line">    <span class="string">"skip_leave_on_interrupt"</span>:<span class="literal">true</span>,</span><br><span class="line">    <span class="string">"ui"</span>:<span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>consul client 配置文件<br>  bind_addr修改为对应的主机IP</p>
  <figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@node7</span> consul]<span class="meta"># cat /etc/consul.d/client.json </span></span><br><span class="line">&#123;</span><br><span class="line"><span class="string">"data_dir"</span>: <span class="string">"/data/consul"</span>,</span><br><span class="line"><span class="string">"enable_script_checks"</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="string">"bind_addr"</span>: <span class="string">"192.168.2.7"</span>,</span><br><span class="line"><span class="string">"retry_join"</span>: [<span class="string">"192.168.2.6"</span>],</span><br><span class="line"><span class="string">"retry_interval"</span>: <span class="string">"30s"</span>,</span><br><span class="line"><span class="string">"rejoin_after_leave"</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="string">"start_join"</span>: [<span class="string">"192.168.2.6"</span>],</span><br><span class="line"><span class="string">"datacenter"</span>: <span class="string">"dc1"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>proxySQL 配置文件</p>
  <figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@node7 consul]# cat /etc/consul.d/proxysql.json </span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"services"</span>: </span><br><span class="line">    [&#123;</span><br><span class="line">        <span class="string">"id"</span>: <span class="string">"proxy2"</span>,</span><br><span class="line">        <span class="string">"name"</span>: <span class="string">"proxysql"</span>,</span><br><span class="line">        <span class="string">"address"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="string">"tags"</span>: [<span class="string">"mysql_proxy"</span>],</span><br><span class="line">        <span class="string">"port"</span>: <span class="number">6033</span>,</span><br><span class="line">        <span class="string">"check"</span>:</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">"args"</span>: [<span class="string">"/etc/consul.d/scripts/proxysql_check.sh"</span>, <span class="string">"192.168.2.7"</span>],</span><br><span class="line">                <span class="string">"interval"</span>: <span class="string">"5s"</span></span><br><span class="line">            &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="5、Consul启动"><a href="#5、Consul启动" class="headerlink" title="5、Consul启动"></a>5、Consul启动</h3><p>consul server和client启动命令一样</p>
<pre><code><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">nohup consul agent <span class="attribute">-config-dir</span>=/etc/consul.d  &gt; /data/consul/consul.log &amp;</span><br><span class="line">启动三个server节点后，node6推选为主</span><br><span class="line"></span><br><span class="line">[root@node6 ~]# consul operator raft list-peers</span><br><span class="line">Node                ID                                   <span class="built_in"> Address </span>           State     Voter  RaftProtocol</span><br><span class="line">node6.timeser.com   328a03ad-eded-a7cc-9ad1-4d9814bd2e38  192.168.2.6:8300   leader    <span class="literal">true</span>   3</span><br><span class="line">node95.timeser.com  6eb2a7fa-15af-7ef3-2e33-a23ae58dc1fe  192.168.2.95:8300  follower  <span class="literal">true</span>   3</span><br><span class="line">node45.timeser.com  75b4eda0-5fb3-fb28-e204-72e1c0b3a6b1  192.168.2.45:8300  follower  <span class="literal">true</span>   3</span><br><span class="line"></span><br><span class="line">启动所有client后会自动加入集群，标记为client</span><br><span class="line"></span><br><span class="line">[root@node110 ~]# consul members</span><br><span class="line">Node                <span class="built_in"> Address </span>            Status <span class="built_in"> Type </span>   Build  Protocol  DC   Segment</span><br><span class="line">node45.timeser.com   192.168.2.45:8301   alive  <span class="built_in"> server </span> 1.4.4  2         dc1  &lt;all&gt;</span><br><span class="line">node6.timeser.com    192.168.2.6:8301    alive  <span class="built_in"> server </span> 1.4.4  2         dc1  &lt;all&gt;</span><br><span class="line">node95.timeser.com   192.168.2.95:8301   alive  <span class="built_in"> server </span> 1.4.4  2         dc1  &lt;all&gt;</span><br><span class="line">node110.timeser.com  192.168.1.110:8301  alive  <span class="built_in"> client </span> 1.4.4  2         dc1  &lt;default&gt;</span><br><span class="line">node115.timeser.com  192.168.1.115:8301  alive  <span class="built_in"> client </span> 1.4.4  2         dc1  &lt;default&gt;</span><br><span class="line">node44.timeser.com   192.168.1.44:8301   alive  <span class="built_in"> client </span> 1.4.4  2         dc1  &lt;default&gt;</span><br><span class="line">node7.timeser.com    192.168.2.7:8301    alive  <span class="built_in"> client </span> 1.4.4  2         dc1  &lt;default&gt;</span><br></pre></td></tr></table></figure>
</code></pre><p>测试<br>[root@ecs-84c5-0001 ~]# ping proxysql.service.timeser -c 5<br>PING proxysql.service.timeser (192.168.2.7) 56(84) bytes of data.<br>64 bytes from node7.timeser.com.node.dc1.timeser (192.168.2.7): icmp_seq=1 ttl=64 time=0.330 ms<br>64 bytes from node7.timeser.com.node.dc1.timeser (192.168.2.7): icmp_seq=2 ttl=64 time=0.358 ms<br>64 bytes from node7.timeser.com.node.dc1.timeser (192.168.2.7): icmp_seq=3 ttl=64 time=0.364 ms<br>64 bytes from node7.timeser.com.node.dc1.timeser (192.168.2.7): icmp_seq=4 ttl=64 time=0.353 ms<br>64 bytes from node7.timeser.com.node.dc1.timeser (192.168.2.7): icmp_seq=5 ttl=64 time=0.351 ms</p>
<p>— proxysql.service.timeser ping statistics —<br>5 packets transmitted, 5 received, 0% packet loss, time 4001ms<br>rtt min/avg/max/mdev = 0.330/0.351/0.364/0.016 ms</p>
<h2 id="二、MySQL主从搭建"><a href="#二、MySQL主从搭建" class="headerlink" title="二、MySQL主从搭建"></a>二、MySQL主从搭建</h2><p>&emsp;&emsp; MySQL主从复制方式有默认的复制方式异步复制，5.5版本之后半同步复制，5.6版本之后新增的GTID复制，包括5.7版本的增强半同步、多源复制；本次采用半同步复制方式配置（MySQL5.6.42）</p>
<table>
<thead>
<tr>
<th>IP</th>
<th>OS</th>
<th>HOSTNAME</th>
<th>SERVICE</th>
<th>VERSION</th>
</tr>
</thead>
<tbody>
<tr>
<td>192.168.1.115</td>
<td>CentOS7.6</td>
<td>node115.timeser.com</td>
<td>MySQL-master</td>
<td>MySQL5.6.42</td>
</tr>
<tr>
<td>192.168.1.110</td>
<td>CentOS7.6</td>
<td>node110.timeser.com</td>
<td>MySQL-slave</td>
<td>MySQL5.6.42</td>
</tr>
<tr>
<td>192.168.1.44</td>
<td>CentOS7.6</td>
<td>node44.timeser.com</td>
<td>MySQL-slave</td>
<td>MySQL5.6.42</td>
</tr>
</tbody>
</table>
<p><strong>配置过程</strong><br><strong>1.server_id</strong></p>
<p>确定server_id不同</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"># node115</span><br><span class="line">"root@node115 [(none)]&gt;show global variables like <span class="emphasis">'%server_id'</span>;</span><br><span class="line"><span class="code">+---------------+</span>-------+</span><br><span class="line">| Variable<span class="emphasis">_name | Value |</span></span><br><span class="line"><span class="emphasis">+---------------+-------+</span></span><br><span class="line"><span class="emphasis">| server_</span>id     | 115   |</span><br><span class="line"><span class="code">+---------------+</span>-------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line"># node44</span><br><span class="line">"root@node44 [(none)]&gt;show global variables like <span class="emphasis">'%server_id'</span>;</span><br><span class="line"><span class="code">+---------------+</span>-------+</span><br><span class="line">| Variable<span class="emphasis">_name | Value |</span></span><br><span class="line"><span class="emphasis">+---------------+-------+</span></span><br><span class="line"><span class="emphasis">| server_</span>id     | 44    |</span><br><span class="line"><span class="code">+---------------+</span>-------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line"># node110</span><br><span class="line">"root@node110 [(none)]&gt;show global variables like <span class="emphasis">'%server_id'</span>;</span><br><span class="line"><span class="code">+---------------+</span>-------+</span><br><span class="line">| Variable<span class="emphasis">_name | Value |</span></span><br><span class="line"><span class="emphasis">+---------------+-------+</span></span><br><span class="line"><span class="emphasis">| server_</span>id     | 110   |</span><br><span class="line"><span class="code">+---------------+</span>-------+</span><br><span class="line">1 row in set (0.01 sec)</span><br></pre></td></tr></table></figure>
<p><strong>2.配置开启GTID</strong> </p>
<p>修改/etc/my.cnf,在[mysqld]下添加：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line"><span class="built_in">..</span>.</span><br><span class="line">gtid_mode = on</span><br><span class="line"><span class="attribute">enforce-gtid</span>=consistency=true</span><br><span class="line"><span class="built_in">..</span>.</span><br></pre></td></tr></table></figure></p>
<p>重启MySQL，登陆客户端检查GTID是否开启<br><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">root<span class="meta">@node115</span> [(none)]&gt;show global variables like '%GTID%';</span><br><span class="line">+---------------------------------+-------------------------------------------------------------------------------------+</span><br><span class="line">|<span class="string"> Variable_name                   </span>|<span class="string"> Value                                                                               </span>|</span><br><span class="line">+---------------------------------+-------------------------------------------------------------------------------------+</span><br><span class="line">|<span class="string"> binlog_gtid_simple_recovery     </span>|<span class="string"> OFF                                                                                 </span>|</span><br><span class="line">|<span class="string"> enforce_gtid_consistency        </span>|<span class="string"> ON                                                                                  </span>|</span><br><span class="line">|<span class="string"> gtid_executed                   </span>|<span class="string"> 45b103b2-7b92-11e9-88a5-fa163e6bcf6d:1-14,                                          </span>|</span><br><span class="line">|<span class="string"> gtid_mode                       </span>|<span class="string"> ON                                                                                  </span>|</span><br><span class="line">|<span class="string"> gtid_owned                      </span>|<span class="string">                                                                                     </span>|</span><br><span class="line">|<span class="string"> gtid_purged                     </span>|<span class="string"> 45b103b2-7b92-11e9-88a5-fa163e6bcf6d:1-6                                            </span>|</span><br><span class="line">|<span class="string"> simplified_binlog_gtid_recovery </span>|<span class="string"> OFF                                                                                 </span>|</span><br><span class="line">+---------------------------------+-------------------------------------------------------------------------------------+</span><br><span class="line">7 rows in set (0.00 sec)</span><br><span class="line">配置的那两项为 <span class="string">"ON"</span> 说明配置成功</span><br></pre></td></tr></table></figure></p>
<p><strong>3.创建复制用户</strong></p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@node115 [(none)]&gt; GRANT REPLICATION SLAVE ON *.* <span class="keyword">to</span> <span class="string">'repl'</span>@<span class="string">'%'</span> identified <span class="keyword">by</span> <span class="string">'123456'</span>;</span><br></pre></td></tr></table></figure>
<p><strong>4.从库指定master信息</strong></p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@<span class="number">44</span> [(none)]&gt; change master to master_host='<span class="number">192.168</span><span class="number">.1</span><span class="number">.115</span>',master_user='repl',master_password='<span class="number">123456</span>',master_port=<span class="number">3306</span>,master_auto_position = <span class="number">1</span>;</span><br></pre></td></tr></table></figure>
<p><strong>5.启动slave并查看主从复制状态</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">root@node44</span> <span class="string">[(none)]&gt;start</span> <span class="string">slave;</span></span><br><span class="line"><span class="string">Query</span> <span class="string">OK,</span> <span class="number">0</span> <span class="string">rows</span> <span class="string">affected</span> <span class="string">(0.00</span> <span class="string">sec)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看主从状态</span></span><br><span class="line"><span class="string">root@node44</span> <span class="string">[(none)]&gt;show</span> <span class="string">slave</span> <span class="string">status\G:</span></span><br><span class="line"><span class="string">***************************</span> <span class="number">1.</span> <span class="string">row</span> <span class="string">***************************</span></span><br><span class="line"><span class="attr">               Slave_IO_State:</span> <span class="string">Waiting</span> <span class="string">for</span> <span class="string">master</span> <span class="string">to</span> <span class="string">send</span> <span class="string">event</span></span><br><span class="line"><span class="attr">                  Master_Host:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.115</span></span><br><span class="line"><span class="attr">                  Master_User:</span> <span class="string">repl</span></span><br><span class="line"><span class="attr">                  Master_Port:</span> <span class="number">3306</span></span><br><span class="line"><span class="attr">                Connect_Retry:</span> <span class="number">60</span></span><br><span class="line"><span class="attr">              Master_Log_File:</span> <span class="string">binlog.000003</span></span><br><span class="line"><span class="attr">          Read_Master_Log_Pos:</span> <span class="number">2682</span></span><br><span class="line"><span class="attr">               Relay_Log_File:</span> <span class="string">relay-bin.000005</span></span><br><span class="line"><span class="attr">                Relay_Log_Pos:</span> <span class="number">439</span></span><br><span class="line"><span class="attr">        Relay_Master_Log_File:</span> <span class="string">binlog.000003</span></span><br><span class="line"><span class="attr">             Slave_IO_Running:</span> <span class="literal">Yes</span></span><br><span class="line"><span class="attr">            Slave_SQL_Running:</span> <span class="literal">Yes</span></span><br><span class="line"><span class="attr">              Replicate_Do_DB:</span> </span><br><span class="line"><span class="attr">          Replicate_Ignore_DB:</span> </span><br><span class="line"><span class="attr">           Replicate_Do_Table:</span> </span><br><span class="line"><span class="attr">       Replicate_Ignore_Table:</span> </span><br><span class="line"><span class="attr">      Replicate_Wild_Do_Table:</span> </span><br><span class="line"><span class="attr">  Replicate_Wild_Ignore_Table:</span> </span><br><span class="line"><span class="attr">                   Last_Errno:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">                   Last_Error:</span> </span><br><span class="line"><span class="attr">                 Skip_Counter:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">          Exec_Master_Log_Pos:</span> <span class="number">2682</span></span><br><span class="line"><span class="attr">              Relay_Log_Space:</span> <span class="number">4693</span></span><br><span class="line"><span class="attr">              Until_Condition:</span> <span class="string">None</span></span><br><span class="line"><span class="attr">               Until_Log_File:</span> </span><br><span class="line"><span class="attr">                Until_Log_Pos:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">           Master_SSL_Allowed:</span> <span class="literal">No</span></span><br><span class="line"><span class="attr">           Master_SSL_CA_File:</span> </span><br><span class="line"><span class="attr">           Master_SSL_CA_Path:</span> </span><br><span class="line"><span class="attr">              Master_SSL_Cert:</span> </span><br><span class="line"><span class="attr">            Master_SSL_Cipher:</span> </span><br><span class="line"><span class="attr">               Master_SSL_Key:</span> </span><br><span class="line"><span class="attr">        Seconds_Behind_Master:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">Master_SSL_Verify_Server_Cert:</span> <span class="literal">No</span></span><br><span class="line"><span class="attr">                Last_IO_Errno:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">                Last_IO_Error:</span> </span><br><span class="line"><span class="attr">               Last_SQL_Errno:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">               Last_SQL_Error:</span> </span><br><span class="line"><span class="attr">  Replicate_Ignore_Server_Ids:</span> </span><br><span class="line"><span class="attr">             Master_Server_Id:</span> <span class="number">115</span></span><br><span class="line"><span class="attr">                  Master_UUID:</span> <span class="number">45</span><span class="string">b103b2-7b92-11e9-88a5-fa163e6bcf6d</span></span><br><span class="line"><span class="attr">             Master_Info_File:</span> <span class="string">/data/mysql/data/master.info</span></span><br><span class="line"><span class="attr">                    SQL_Delay:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">          SQL_Remaining_Delay:</span> <span class="literal">NULL</span></span><br><span class="line"><span class="attr">      Slave_SQL_Running_State:</span> <span class="string">Slave</span> <span class="string">has</span> <span class="string">read</span> <span class="string">all</span> <span class="string">relay</span> <span class="string">log;</span> <span class="string">waiting</span> <span class="string">for</span> <span class="string">the</span> <span class="string">slave</span> <span class="string">I/O</span> <span class="string">thread</span> <span class="string">to</span> <span class="string">update</span> <span class="string">it</span></span><br><span class="line"><span class="attr">           Master_Retry_Count:</span> <span class="number">86400</span></span><br><span class="line"><span class="attr">                  Master_Bind:</span> </span><br><span class="line"><span class="attr">      Last_IO_Error_Timestamp:</span> </span><br><span class="line"><span class="attr">     Last_SQL_Error_Timestamp:</span> </span><br><span class="line"><span class="attr">               Master_SSL_Crl:</span> </span><br><span class="line"><span class="attr">           Master_SSL_Crlpath:</span> </span><br><span class="line"><span class="attr">           Retrieved_Gtid_Set:</span> <span class="number">45</span><span class="attr">b103b2-7b92-11e9-88a5-fa163e6bcf6d:1-14</span></span><br><span class="line"><span class="attr">            Executed_Gtid_Set:</span> <span class="number">45</span><span class="attr">b103b2-7b92-11e9-88a5-fa163e6bcf6d:1-14</span></span><br><span class="line"><span class="attr">                Auto_Position:</span> <span class="number">1</span></span><br><span class="line"><span class="number">1</span> <span class="string">row</span> <span class="string">in</span> <span class="string">set</span> <span class="string">(0.00</span> <span class="string">sec)</span></span><br></pre></td></tr></table></figure>
<p><strong>6.开启半同步复制</strong></p>
<p>主库添加配置文件</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">/etc/my.cnf</span><br><span class="line"></span><br><span class="line">plugin_dir=/usr/local/mysql/lib/plugin             <span class="comment">##根据实际情况修改</span></span><br><span class="line">plugin_load =<span class="string">"rpl_semi_sync_master=semisync_master.so"</span></span><br><span class="line">loose_rpl_semi_sync_master_enabled = 1</span><br><span class="line">loose_rpl_semi_sync_master_timeout = 1000</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启MySQL查看</span></span><br><span class="line"></span><br><span class="line">root<span class="meta">@node115</span> [(none)]&gt;show variables like '%rpl_semi_sync_master%';</span><br><span class="line">+------------------------------------+-------+</span><br><span class="line">|<span class="string"> Variable_name                      </span>|<span class="string"> Value </span>|</span><br><span class="line">+------------------------------------+-------+</span><br><span class="line">|<span class="string"> rpl_semi_sync_master_enabled       </span>|<span class="string"> ON    </span>|</span><br><span class="line">|<span class="string"> rpl_semi_sync_master_timeout       </span>|<span class="string"> 1000  </span>|</span><br><span class="line">|<span class="string"> rpl_semi_sync_master_trace_level   </span>|<span class="string"> 32    </span>|</span><br><span class="line">|<span class="string"> rpl_semi_sync_master_wait_no_slave </span>|<span class="string"> ON    </span>|</span><br><span class="line">+------------------------------------+-------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>从库添加配置文件</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">/etc/my.cnf</span><br><span class="line"></span><br><span class="line">plugin_dir=/usr/local/mysql/lib/plugin             <span class="comment">##根据实际情况修改</span></span><br><span class="line">plugin_load =<span class="string">"rpl_semi_sync_slave=semisync_slave.so"</span></span><br><span class="line">loose_rpl_semi_sync_slave_enabled = 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启MySQL查看</span></span><br><span class="line"></span><br><span class="line">root<span class="meta">@node44</span> [(none)]&gt;show variables like '%rpl%';</span><br><span class="line">+---------------------------------+----------+</span><br><span class="line">|<span class="string"> Variable_name                   </span>|<span class="string"> Value    </span>|</span><br><span class="line">+---------------------------------+----------+</span><br><span class="line">|<span class="string"> rpl_semi_sync_slave_enabled     </span>|<span class="string"> ON       </span>|</span><br><span class="line">|<span class="string"> rpl_semi_sync_slave_trace_level </span>|<span class="string"> 32       </span>|</span><br><span class="line">|<span class="string"> rpl_stop_slave_timeout          </span>|<span class="string"> 31536000 </span>|</span><br><span class="line">+---------------------------------+----------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>主从同步配置完成</p>
<h2 id="三、配置Proxy-SQL读写分离"><a href="#三、配置Proxy-SQL读写分离" class="headerlink" title="三、配置Proxy SQL读写分离"></a>三、配置Proxy SQL读写分离</h2><p>在proxy SQL主机上安装proxysql服务：</p>
<p>proxy SQL有两个版本，percona 和官方版本，percona版本增强了一些功能，比较稳定。</p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="title">@node7</span> ~]# wget https://www.percona.com/downloads/proxysql/proxysql<span class="number">-1.4</span>.<span class="number">14</span>/binary/redhat/<span class="number">7</span>/<span class="keyword">x</span><span class="number">86</span>_<span class="number">64</span>/proxysql<span class="number">-1.4</span>.<span class="number">14</span><span class="number">-1.1</span>.el<span class="number">7</span>.<span class="keyword">x</span><span class="number">86</span>_<span class="number">64</span>.rpm</span><br><span class="line">[root<span class="title">@node7</span> ~]# yum install proxysql<span class="number">-1.4</span>.<span class="number">14</span><span class="number">-1.1</span>.el<span class="number">7</span>.<span class="keyword">x</span><span class="number">86</span>_<span class="number">64</span>.rpm</span><br></pre></td></tr></table></figure>
<p>在配置proxy SQL服务前，需要在后端数据库中添加相应的proxysql授权账号<br><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@node115 [(<span class="literal">none</span>)]&gt; grant all <span class="keyword">on</span> *.* <span class="title">to</span> <span class="string">'myadmin'</span>@<span class="string">'%'</span> <span class="title">identified</span> <span class="title">by</span> <span class="string">'123456'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> <span class="built_in">sec</span>)</span><br><span class="line"><span class="comment"># 创建健康检测的账号</span></span><br><span class="line">root@node115 [(<span class="literal">none</span>)]&gt; grant all <span class="keyword">on</span> *.* <span class="title">to</span> <span class="string">'monitor'</span>@<span class="string">'%'</span> <span class="title">identified</span> <span class="title">by</span> <span class="string">'123456'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> <span class="built_in">sec</span>)</span><br></pre></td></tr></table></figure></p>
<p><strong>创建配置文件</strong></p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">datadir="/var/lib/proxysql"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># proxysql 管理账号</span></span><br><span class="line"><span class="attr">admin_variables=</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="attr">admin_credentials="admin:admin"</span></span><br><span class="line">        <span class="attr">mysql_ifaces="0.0.0.0:6032"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 全局配置</span></span><br><span class="line"><span class="attr">mysql_variables=</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="attr">threads=4</span></span><br><span class="line">        <span class="attr">max_connections=2048</span></span><br><span class="line">        <span class="attr">default_query_delay=0</span></span><br><span class="line">        <span class="attr">default_query_timeout=36000000</span></span><br><span class="line">        <span class="attr">have_compress=true</span></span><br><span class="line">        <span class="attr">poll_timeout=2000</span></span><br><span class="line">        <span class="attr">interfaces="0.0.0.0:6033"</span></span><br><span class="line">        <span class="attr">default_schema="information_schema"</span></span><br><span class="line">        <span class="attr">stacksize=1048576</span></span><br><span class="line">        <span class="attr">server_version="5.6.42"</span></span><br><span class="line">        <span class="attr">connect_timeout_server=3000</span></span><br><span class="line">        <span class="attr">monitor_username="monitor"</span></span><br><span class="line">        <span class="attr">monitor_password="123456"</span></span><br><span class="line">        <span class="attr">monitor_history=600000</span></span><br><span class="line">        <span class="attr">monitor_connect_interval=120000</span></span><br><span class="line">        <span class="attr">monitor_ping_interval=120000</span></span><br><span class="line">        <span class="attr">monitor_read_only_interval=15000</span></span><br><span class="line">        <span class="attr">monitor_read_only_timeout=500</span></span><br><span class="line">        <span class="attr">ping_interval_server_msec=120000</span></span><br><span class="line">        <span class="attr">ping_timeout_server=500</span></span><br><span class="line">        <span class="attr">commands_stats=true</span></span><br><span class="line">        <span class="attr">sessions_sort=true</span></span><br><span class="line">        <span class="attr">connect_retries_on_failure=10</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 后端MySQL服务</span></span><br><span class="line"></span><br><span class="line"><span class="attr">mysql_servers</span> =</span><br><span class="line">(</span><br><span class="line">        &#123;</span><br><span class="line">                <span class="attr">address</span> = <span class="string">"192.168.1.115"</span></span><br><span class="line">                <span class="attr">port</span> = <span class="number">3306</span></span><br><span class="line">                <span class="attr">hostgroup</span> = <span class="number">30</span></span><br><span class="line">                <span class="attr">status</span> = <span class="string">"ONLINE"</span></span><br><span class="line">                <span class="attr">weight</span> = <span class="number">1</span></span><br><span class="line">                <span class="attr">compression</span> = <span class="number">0</span></span><br><span class="line">                <span class="attr">max_replication_lag</span> = <span class="number">10</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">                <span class="attr">address</span> = <span class="string">"192.168.1.44"</span></span><br><span class="line">                <span class="attr">port</span> = <span class="number">3306</span></span><br><span class="line">                <span class="attr">hostgroup</span> = <span class="number">40</span></span><br><span class="line">                <span class="attr">status</span> = <span class="string">"ONLINE"</span></span><br><span class="line">                <span class="attr">weight</span> = <span class="number">1</span></span><br><span class="line">                <span class="attr">compression</span> = <span class="number">0</span></span><br><span class="line">                <span class="attr">max_replication_lag</span> = <span class="number">10</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">                <span class="attr">address</span> = <span class="string">"192.168.1.110"</span></span><br><span class="line">                <span class="attr">port</span> = <span class="number">3306</span></span><br><span class="line">                <span class="attr">hostgroup</span> = <span class="number">40</span></span><br><span class="line">                <span class="attr">status</span> = <span class="string">"ONLINE"</span></span><br><span class="line">                <span class="attr">weight</span> = <span class="number">1</span></span><br><span class="line">                <span class="attr">compression</span> = <span class="number">0</span></span><br><span class="line">                <span class="attr">max_replication_lag</span> = <span class="number">10</span></span><br><span class="line">        &#125;</span><br><span class="line">)</span><br><span class="line"><span class="comment"># 后端MySQL账号</span></span><br><span class="line">mysql_users:</span><br><span class="line">(</span><br><span class="line">        &#123;</span><br><span class="line">                <span class="attr">username</span> = <span class="string">"myadmin"</span> <span class="comment"># no default , required</span></span><br><span class="line">                <span class="attr">password</span> = <span class="string">"123456"</span> <span class="comment"># default: ''</span></span><br><span class="line">                <span class="attr">default_hostgroup</span> = <span class="number">30</span> <span class="comment"># default: 0</span></span><br><span class="line">                <span class="attr">active</span> = <span class="number">1</span>            <span class="comment"># default: 1</span></span><br><span class="line">        &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 读写分离规则</span></span><br><span class="line">mysql_query_rules:</span><br><span class="line">(</span><br><span class="line">       &#123;</span><br><span class="line">               <span class="attr">rule_id=1</span></span><br><span class="line">               <span class="attr">active=1</span></span><br><span class="line">               <span class="attr">match_pattern="^SELECT</span> .* FOR UPDATE$<span class="string">"</span></span><br><span class="line"><span class="string">               destination_hostgroup=30</span></span><br><span class="line"><span class="string">               apply=1</span></span><br><span class="line"><span class="string">       &#125;,</span></span><br><span class="line"><span class="string">       &#123;</span></span><br><span class="line"><span class="string">               rule_id=2</span></span><br><span class="line"><span class="string">               active=1</span></span><br><span class="line"><span class="string">               match_pattern="</span>^SELECT<span class="string">"</span></span><br><span class="line"><span class="string">               destination_hostgroup=40</span></span><br><span class="line"><span class="string">               apply=1</span></span><br><span class="line"><span class="string">       &#125;</span></span><br><span class="line"><span class="string">)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># MySQL读写组ID（此配置结合MHA实现高可用）</span></span><br><span class="line"><span class="string">mysql_replication_hostgroups=</span></span><br><span class="line"><span class="string">(</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">                writer_hostgroup=30</span></span><br><span class="line"><span class="string">                reader_hostgroup=40</span></span><br><span class="line"><span class="string">                comment="</span>test repl <span class="number">1</span><span class="string">"</span></span><br><span class="line"><span class="string">       &#125;</span></span><br><span class="line"><span class="string">)</span></span><br></pre></td></tr></table></figure>
<p>启动proxy SQL</p>
<figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@node7 ~]<span class="comment"># systemctl start proxysql</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看端口，启动了四个6033</span></span><br><span class="line">[root@node7 etc]<span class="comment"># ss -tnl|grep :6033</span></span><br><span class="line">LISTEN    <span class="number"> 0 </span>    <span class="number"> 1024 </span>        *:6033                     *:*                  </span><br><span class="line">LISTEN    <span class="number"> 0 </span>    <span class="number"> 1024 </span>        *:6033                     *:*                  </span><br><span class="line">LISTEN    <span class="number"> 0 </span>    <span class="number"> 1024 </span>        *:6033                     *:*                  </span><br><span class="line">LISTEN    <span class="number"> 0 </span>    <span class="number"> 1024 </span>        *:6033                     *:*</span><br></pre></td></tr></table></figure>
<p>proxy SQL配置完成！</p>
<blockquote>
<p>注：proxy SQL在开启monitor健康检查的情况下必须在MySQL从库配置文件添加 read_only=1,否者会一直报错</p>
</blockquote>
<h2 id="四、MHA部署"><a href="#四、MHA部署" class="headerlink" title="四、MHA部署"></a>四、MHA部署</h2><p>&emsp;&emsp;MHA在在msyql高可用方面是一个相对成熟的解决方案，是一套优秀的作为mysql高可用性环境下故障切换和主从提升的高可用软件。在mysql故障切换过程中，MHA能做到在0~30秒内自动完成数据库的故障切换操作，并且在进行故障切换的过程中，MHA能在最大程度上保证数据的一致性，从而达到真正意义上的高可用。</p>
<p>&emsp;&emsp;MHA由两部分组成：manager(管理节点)，node(数据节点)。manager可以单独部署在一台独立服务器上管理多个master-slave集群，也可以部署在一台slave节点上。node运行在每台mysql服务器上，manager会持续检测master节点，当master出现故障时，manager会自动将拥有最新数据的slave提升为新的master，之后将所有其他slave重新指向这个新的master。</p>
<p><strong>配置ssh通信</strong></p>
<blockquote>
<p>MHA 集群中的各节点彼此之间均需要基于ssh互信通信，以实现远程控制及数据管理功能。</p>
</blockquote>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># manager(<span class="number">192.168</span><span class="number">.2</span><span class="number">.7</span>)</span><br><span class="line"># 创建公钥</span><br><span class="line">[root@node7 ~]# ssh-keygen</span><br><span class="line"># 分发公钥</span><br><span class="line">[root@node7 ~]# for n in <span class="number">115</span> <span class="number">110</span> <span class="number">44</span>;do ssh-copy-id <span class="number">192.168</span><span class="number">.1</span>.$n;done</span><br></pre></td></tr></table></figure>
<p><strong>安装MHA</strong> </p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 下载两个MHA文件</span></span><br><span class="line"><span class="number">1.</span> mha4mysql-manager<span class="number">-0.58</span><span class="number">-0.</span>el7.noarch.rpm</span><br><span class="line"><span class="number">2.</span> mha4mysql-node<span class="number">-0.58</span><span class="number">-0.</span>el7.noarch.rpm</span><br><span class="line"></span><br><span class="line">[root<span class="symbol">@node7</span> ~]<span class="meta"># yum -y install epel-release  #安装epel源</span></span><br><span class="line">[root<span class="symbol">@node7</span> ~]<span class="meta"># yum repolist    #更新仓库</span></span><br><span class="line">[root<span class="symbol">@node7</span> ~]<span class="meta"># yum -y install ./mha4mysql-*.rpm    #在manager安装MHA的manager和node</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># 把MHA的node拷贝到另外三台mysql节点</span></span><br><span class="line">[root<span class="symbol">@node7</span> ~]<span class="meta"># for n in 115 110 44<span class="comment">;do scp mha4mysql-node-0.58-0.el7.noarch.rpm 192.168.1.$n:/root;done</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta"># 三台mysql节点安装MHA node</span></span><br><span class="line">[root<span class="symbol">@node115</span> ~]<span class="meta"># yum -y install ./mha4mysql-node-0.58-0.el7.noarch.rpm</span></span><br></pre></td></tr></table></figure>
<p><strong>配置MHA</strong><br><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#manager节点</span></span><br><span class="line"><span class="section">[root@node7 ~]</span><span class="comment"># mkdir /etc/masterha</span></span><br><span class="line"><span class="section">[root@node7 ~]</span><span class="comment"># vim /etc/masterha/app1.cnf</span></span><br><span class="line"><span class="section">[server default]</span></span><br><span class="line"><span class="attr">user</span>=myadmin</span><br><span class="line"><span class="attr">password</span>=<span class="number">123456</span></span><br><span class="line"><span class="attr">manager_workdir</span>=/data/masterha/app1</span><br><span class="line"><span class="attr">manager_log</span>=/data/masterha/app1/manager.log</span><br><span class="line"><span class="attr">remote_workdir</span>=/data/masterha/app1</span><br><span class="line"><span class="attr">master_binlog_dir</span>=/data/mysql/logs/    </span><br><span class="line"><span class="attr">ssh_user</span>=root</span><br><span class="line"><span class="attr">repl_user</span>=repl</span><br><span class="line"><span class="attr">repl_password</span>=<span class="number">123456</span></span><br><span class="line"><span class="attr">ping_interval</span>=<span class="number">1</span></span><br><span class="line"><span class="section">[serverl]</span></span><br><span class="line"><span class="attr">hostname</span>=<span class="number">192.168</span>.<span class="number">1.115</span></span><br><span class="line"><span class="attr">candidate_master</span>=<span class="number">1</span></span><br><span class="line"><span class="section">[server2]</span></span><br><span class="line"><span class="attr">hostname</span>=<span class="number">192.168</span>.<span class="number">1.110</span></span><br><span class="line"><span class="attr">candidate_master</span>=<span class="number">1</span></span><br><span class="line"><span class="section">[server3]</span></span><br><span class="line"><span class="attr">hostname</span>=<span class="number">192.168</span>.<span class="number">1.44</span></span><br><span class="line"><span class="attr">candidate_master</span>=<span class="number">1</span></span><br></pre></td></tr></table></figure></p>
<p><strong>启动MHA</strong><br><img src="https://i.imgur.com/leJkbEe.png" alt></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 检查各路通讯是否OK</span></span><br><span class="line">[root@node7 ~]# masterha_check_ssh <span class="attribute">--conf</span>=/etc/masterha/app.cnf</span><br><span class="line">[root@node7 ~]# masterha_check_ssh <span class="attribute">--conf</span>=/etc/masterha/app.cnf </span><br><span class="line">Tue May 28 12:44:24 2019 - [<span class="builtin-name">warning</span>] Global configuration file /etc/masterha_default.cnf <span class="keyword">not</span> found. Skipping.</span><br><span class="line">Tue May 28 12:44:24 2019 - [<span class="builtin-name">info</span>] Reading application<span class="built_in"> default </span>configuration <span class="keyword">from</span> /etc/masterha/app.cnf<span class="built_in">..</span></span><br><span class="line">Tue May 28 12:44:24 2019 - [<span class="builtin-name">info</span>] Reading<span class="built_in"> server </span>configuration <span class="keyword">from</span> /etc/masterha/app.cnf<span class="built_in">..</span></span><br><span class="line">Tue May 28 12:44:24 2019 - [<span class="builtin-name">info</span>] Starting SSH<span class="built_in"> connection </span>tests<span class="built_in">..</span></span><br><span class="line">Tue May 28 12:44:24 2019 - [<span class="builtin-name">debug</span>]</span><br><span class="line">Tue May 28 12:44:24 2019 - [<span class="builtin-name">debug</span>]  Connecting via SSH <span class="keyword">from</span> root@192.168.1.44(192.168.1.44:22) <span class="keyword">to</span> root@192.168.1.110(192.168.1.110:22)<span class="built_in">..</span></span><br><span class="line">Tue May 28 12:44:24 2019 - [<span class="builtin-name">debug</span>] ok.</span><br><span class="line">Tue May 28 12:44:24 2019 - [<span class="builtin-name">debug</span>]  Connecting via SSH <span class="keyword">from</span> root@192.168.1.44(192.168.1.44:22) <span class="keyword">to</span> root@192.168.1.115(192.168.1.115:22)<span class="built_in">..</span></span><br><span class="line">Tue May 28 12:44:24 2019 - [<span class="builtin-name">debug</span>] ok.</span><br><span class="line">Tue May 28 12:44:24 2019 - [<span class="builtin-name">debug</span>]</span><br><span class="line">Tue May 28 12:44:24 2019 - [<span class="builtin-name">debug</span>]  Connecting via SSH <span class="keyword">from</span> root@192.168.1.110(192.168.1.110:22) <span class="keyword">to</span> root@192.168.1.115(192.168.1.115:22)<span class="built_in">..</span></span><br><span class="line">Tue May 28 12:44:24 2019 - [<span class="builtin-name">debug</span>] ok.</span><br><span class="line">Tue May 28 12:44:24 2019 - [<span class="builtin-name">debug</span>]  Connecting via SSH <span class="keyword">from</span> root@192.168.1.110(192.168.1.110:22) <span class="keyword">to</span> root@192.168.1.44(192.168.1.44:22)<span class="built_in">..</span></span><br><span class="line">Tue May 28 12:44:24 2019 - [<span class="builtin-name">debug</span>] ok.</span><br><span class="line">Tue May 28 12:44:24 2019 - [<span class="builtin-name">debug</span>]</span><br><span class="line">Tue May 28 12:44:25 2019 - [<span class="builtin-name">debug</span>]  Connecting via SSH <span class="keyword">from</span> root@192.168.1.115(192.168.1.115:22) <span class="keyword">to</span> root@192.168.1.44(192.168.1.44:22)<span class="built_in">..</span></span><br><span class="line">Tue May 28 12:44:25 2019 - [<span class="builtin-name">debug</span>] ok.</span><br><span class="line">Tue May 28 12:44:25 2019 - [<span class="builtin-name">debug</span>]  Connecting via SSH <span class="keyword">from</span> root@192.168.1.115(192.168.1.115:22) <span class="keyword">to</span> root@192.168.1.110(192.168.1.110:22)<span class="built_in">..</span></span><br><span class="line">Tue May 28 12:44:25 2019 - [<span class="builtin-name">debug</span>] ok.</span><br><span class="line">Tue May 28 12:44:25 2019 - [<span class="builtin-name">info</span>] All SSH<span class="built_in"> connection </span>tests passed successfully.</span><br><span class="line"><span class="comment"># 检测主从节点，最后出现OK，所有都正常。</span></span><br><span class="line">[root@node7 ~]# masterha_check_repl <span class="attribute">--conf</span>=/etc/masterha/app.cnf</span><br><span class="line"><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span>.</span><br><span class="line">MySQL Replication<span class="built_in"> Health </span>is OK.</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动MHA；nohup后台启动</span></span><br><span class="line">[root@node7 ~]# nohup masterha_manager <span class="attribute">--conf</span>=/etc/masterha/app.cnf &amp;&gt; /data/masterha/app1/manager.log &amp;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查master节点的状态，运行中，成功启动</span></span><br><span class="line">[root@node7 ~]# masterha_check_status <span class="attribute">--conf</span>=/etc/masterha/app.cnf</span><br><span class="line">app1 (pid:1551) is running(0:PING_OK), master:192.168.1.115</span><br></pre></td></tr></table></figure>
<p><strong>测试故障转移</strong></p>
<figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 192.168.1.115(master)</span></span><br><span class="line"><span class="comment"># 停掉主节点MySQL服务</span></span><br><span class="line">[root@node115 ~]<span class="comment"># /etc/init.d/mysql stop</span></span><br><span class="line">shutting down MySQL ..........  [ok]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在MHA节点上查看日志</span></span><br><span class="line">[root@ecs-3c90 masterha]<span class="comment"># tailf /data/masterha/app1/manager.log </span></span><br><span class="line">192.168.1.115(192.168.1.115:3306) (current master)</span><br><span class="line"> +--192.168.1.44(192.168.1.44:3306)</span><br><span class="line"> +--192.168.1.110(192.168.1.110:3306)</span><br><span class="line"></span><br><span class="line">Mon May<span class="number"> 20 </span>16:44:39<span class="number"> 2019 </span>- [warning] master_ip_failover_script is not defined.</span><br><span class="line">Mon May<span class="number"> 20 </span>16:44:39<span class="number"> 2019 </span>- [warning] shutdown_script is not defined.</span><br><span class="line">Mon May<span class="number"> 20 </span>16:44:39<span class="number"> 2019 </span>- [info] Set master ping interval<span class="number"> 1 </span>seconds.</span><br><span class="line">Mon May<span class="number"> 20 </span>16:44:39<span class="number"> 2019 </span>- [warning] secondary_check_script is not defined. It is highly recommended setting it to check master reachability from two or more routes.</span><br><span class="line">Mon May<span class="number"> 20 </span>16:44:39<span class="number"> 2019 </span>- [info] Starting ping health check on 192.168.1.115(192.168.1.115:3306)..</span><br><span class="line">Mon May<span class="number"> 20 </span>16:44:39<span class="number"> 2019 </span>- [info] Ping(SELECT) succeeded, waiting until MySQL doesn't respond..</span><br><span class="line"></span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:30<span class="number"> 2019 </span>- [warning] Got error on MySQL select ping:<span class="number"> 2006 </span>(MySQL server has gone away)</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:30<span class="number"> 2019 </span>- [info] Executing SSH check script: exit 0</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:30<span class="number"> 2019 </span>- [info] HealthCheck: SSH to 192.168.1.115 is reachable.</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:31<span class="number"> 2019 </span>- [warning] Got error on MySQL connect:<span class="number"> 2003 </span>(Can't connect to MySQL server on '192.168.1.115' (111))</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:31<span class="number"> 2019 </span>- [warning] Connection failed<span class="number"> 2 </span>time(s)..</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:32<span class="number"> 2019 </span>- [warning] Got error on MySQL connect:<span class="number"> 2003 </span>(Can't connect to MySQL server on '192.168.1.115' (111))</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:32<span class="number"> 2019 </span>- [warning] Connection failed<span class="number"> 3 </span>time(s)..</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:33<span class="number"> 2019 </span>- [warning] Got error on MySQL connect:<span class="number"> 2003 </span>(Can't connect to MySQL server on '192.168.1.115' (111))</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:33<span class="number"> 2019 </span>- [warning] Connection failed<span class="number"> 4 </span>time(s)..</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:33<span class="number"> 2019 </span>- [warning] Master is not reachable from health checker!</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:33<span class="number"> 2019 </span>- [warning] Master 192.168.1.115(192.168.1.115:3306) is not reachable!</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:33<span class="number"> 2019 </span>- [warning] SSH is reachable.</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:33<span class="number"> 2019 </span>- [info] Connecting to a master server failed. Reading configuration file /etc/masterha_default.cnf and /etc/masterha/app.cnf again, and trying to connect to all servers to check server status..</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:33<span class="number"> 2019 </span>- [warning] Global configuration file /etc/masterha_default.cnf not found. Skipping.</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:33<span class="number"> 2019 </span>- [info] Reading application default configuration from /etc/masterha/app.cnf..</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:33<span class="number"> 2019 </span>- [info] Reading server configuration from /etc/masterha/app.cnf..</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:34<span class="number"> 2019 </span>- [info] GTID failover mode = 1</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:34<span class="number"> 2019 </span>- [info] Dead Servers:</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:34<span class="number"> 2019 </span>- [info]   192.168.1.115(192.168.1.115:3306)</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:34<span class="number"> 2019 </span>- [info] Alive Servers:</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:34<span class="number"> 2019 </span>- [info]   192.168.1.44(192.168.1.44:3306)</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:34<span class="number"> 2019 </span>- [info]   192.168.1.110(192.168.1.110:3306)</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:34<span class="number"> 2019 </span>- [info] Alive Slaves:</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:34<span class="number"> 2019 </span>- [info]   192.168.1.44(192.168.1.44:3306)  Version=5.6.42-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:34<span class="number"> 2019 </span>- [info]     GTID ON</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:34<span class="number"> 2019 </span>- [info]     Replicating from 192.168.1.115(192.168.1.115:3306)</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:34<span class="number"> 2019 </span>- [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:34<span class="number"> 2019 </span>- [info]   192.168.1.110(192.168.1.110:3306)  Version=5.6.42-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:34<span class="number"> 2019 </span>- [info]     GTID ON</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:34<span class="number"> 2019 </span>- [info]     Replicating from 192.168.1.115(192.168.1.115:3306)</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:34<span class="number"> 2019 </span>- [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:34<span class="number"> 2019 </span>- [info] Checking slave configurations..</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:34<span class="number"> 2019 </span>- [info] Checking replication filtering settings..</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:34<span class="number"> 2019 </span>- [info]  Replication filtering check ok.</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:34<span class="number"> 2019 </span>- [info] Master is down!</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:34<span class="number"> 2019 </span>- [info] Terminating monitoring script.</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:34<span class="number"> 2019 </span>- [info] Got exit code<span class="number"> 20 </span>(Master dead).</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:34<span class="number"> 2019 </span>- [info] MHA::MasterFailover version 0.58.</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:34<span class="number"> 2019 </span>- [info] Starting master failover.</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:34<span class="number"> 2019 </span>- [info] </span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:34<span class="number"> 2019 </span>- [info] * Phase 1: Configuration Check Phase..</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:34<span class="number"> 2019 </span>- [info] </span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:35<span class="number"> 2019 </span>- [info] GTID failover mode = 1</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:35<span class="number"> 2019 </span>- [info] Dead Servers:</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:35<span class="number"> 2019 </span>- [info]   192.168.1.115(192.168.1.115:3306)</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:35<span class="number"> 2019 </span>- [info] Checking master reachability via MySQL(double check)...</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:35<span class="number"> 2019 </span>- [info]  ok.</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:35<span class="number"> 2019 </span>- [info] Alive Servers:</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:35<span class="number"> 2019 </span>- [info]   192.168.1.44(192.168.1.44:3306)</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:35<span class="number"> 2019 </span>- [info]   192.168.1.110(192.168.1.110:3306)</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:35<span class="number"> 2019 </span>- [info] Alive Slaves:</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:35<span class="number"> 2019 </span>- [info]   192.168.1.44(192.168.1.44:3306)  Version=5.6.42-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:35<span class="number"> 2019 </span>- [info]     GTID ON</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:35<span class="number"> 2019 </span>- [info]     Replicating from 192.168.1.115(192.168.1.115:3306)</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:35<span class="number"> 2019 </span>- [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:35<span class="number"> 2019 </span>- [info]   192.168.1.110(192.168.1.110:3306)  Version=5.6.42-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:35<span class="number"> 2019 </span>- [info]     GTID ON</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:35<span class="number"> 2019 </span>- [info]     Replicating from 192.168.1.115(192.168.1.115:3306)</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:35<span class="number"> 2019 </span>- [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:35<span class="number"> 2019 </span>- [info] Starting GTID based failover.</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:35<span class="number"> 2019 </span>- [info] </span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:35<span class="number"> 2019 </span>- [info] ** Phase 1: Configuration Check Phase completed.</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:35<span class="number"> 2019 </span>- [info] </span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:35<span class="number"> 2019 </span>- [info] * Phase 2: Dead Master Shutdown Phase..</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:35<span class="number"> 2019 </span>- [info] </span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:35<span class="number"> 2019 </span>- [info] Forcing shutdown so that applications never connect to the current master..</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:35<span class="number"> 2019 </span>- [warning] master_ip_failover_script is not set. Skipping invalidating dead master IP address.</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:35<span class="number"> 2019 </span>- [warning] shutdown_script is not set. Skipping explicit shutting down of the dead master.</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:36<span class="number"> 2019 </span>- [info] * Phase 2: Dead Master Shutdown Phase completed.</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:36<span class="number"> 2019 </span>- [info] </span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:36<span class="number"> 2019 </span>- [info] * Phase 3: Master Recovery Phase..</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:36<span class="number"> 2019 </span>- [info] </span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:36<span class="number"> 2019 </span>- [info] * Phase 3.1: Getting Latest Slaves Phase..</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:36<span class="number"> 2019 </span>- [info] </span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:36<span class="number"> 2019 </span>- [info] The latest binary log file/position on all slaves is binlog.000005:447</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:36<span class="number"> 2019 </span>- [info] Retrieved Gtid Set: e3b3cfbd-6666-11e9-be99-fa163e6bcf6d:35-49</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:36<span class="number"> 2019 </span>- [info] Latest slaves (Slaves that received relay log files to the latest):</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:36<span class="number"> 2019 </span>- [info]   192.168.1.44(192.168.1.44:3306)  Version=5.6.42-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:36<span class="number"> 2019 </span>- [info]     GTID ON</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:36<span class="number"> 2019 </span>- [info]     Replicating from 192.168.1.115(192.168.1.115:3306)</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:36<span class="number"> 2019 </span>- [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:36<span class="number"> 2019 </span>- [info]   192.168.1.110(192.168.1.110:3306)  Version=5.6.42-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:36<span class="number"> 2019 </span>- [info]     GTID ON</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:36<span class="number"> 2019 </span>- [info]     Replicating from 192.168.1.115(192.168.1.115:3306)</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:36<span class="number"> 2019 </span>- [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:36<span class="number"> 2019 </span>- [info] The oldest binary log file/position on all slaves is binlog.000005:447</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:36<span class="number"> 2019 </span>- [info] Retrieved Gtid Set: e3b3cfbd-6666-11e9-be99-fa163e6bcf6d:35-49</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:36<span class="number"> 2019 </span>- [info] Oldest slaves:</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:36<span class="number"> 2019 </span>- [info]   192.168.1.44(192.168.1.44:3306)  Version=5.6.42-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:36<span class="number"> 2019 </span>- [info]     GTID ON</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:36<span class="number"> 2019 </span>- [info]     Replicating from 192.168.1.115(192.168.1.115:3306)</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:36<span class="number"> 2019 </span>- [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:36<span class="number"> 2019 </span>- [info]   192.168.1.110(192.168.1.110:3306)  Version=5.6.42-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:36<span class="number"> 2019 </span>- [info]     GTID ON</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:36<span class="number"> 2019 </span>- [info]     Replicating from 192.168.1.115(192.168.1.115:3306)</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:36<span class="number"> 2019 </span>- [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:36<span class="number"> 2019 </span>- [info] </span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:36<span class="number"> 2019 </span>- [info] * Phase 3.3: Determining New Master Phase..</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:36<span class="number"> 2019 </span>- [info] </span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:36<span class="number"> 2019 </span>- [info] Searching new master from slaves..</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:36<span class="number"> 2019 </span>- [info]  Candidate masters from the configuration file:</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:36<span class="number"> 2019 </span>- [info]   192.168.1.44(192.168.1.44:3306)  Version=5.6.42-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:36<span class="number"> 2019 </span>- [info]     GTID ON</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:36<span class="number"> 2019 </span>- [info]     Replicating from 192.168.1.115(192.168.1.115:3306)</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:36<span class="number"> 2019 </span>- [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:36<span class="number"> 2019 </span>- [info]   192.168.1.110(192.168.1.110:3306)  Version=5.6.42-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:36<span class="number"> 2019 </span>- [info]     GTID ON</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:36<span class="number"> 2019 </span>- [info]     Replicating from 192.168.1.115(192.168.1.115:3306)</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:36<span class="number"> 2019 </span>- [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:36<span class="number"> 2019 </span>- [info]  Non-candidate masters:</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:36<span class="number"> 2019 </span>- [info]  Searching from candidate_master slaves which have received the latest relay log events..</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:36<span class="number"> 2019 </span>- [info] New master is 192.168.1.44(192.168.1.44:3306)</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:36<span class="number"> 2019 </span>- [info] Starting master failover..</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:36<span class="number"> 2019 </span>- [info] </span><br><span class="line">From:</span><br><span class="line">192.168.1.115(192.168.1.115:3306) (current master)</span><br><span class="line"> +--192.168.1.44(192.168.1.44:3306)</span><br><span class="line"> +--192.168.1.110(192.168.1.110:3306)</span><br><span class="line"></span><br><span class="line">To:</span><br><span class="line">192.168.1.44(192.168.1.44:3306) (new master)</span><br><span class="line"> +--192.168.1.110(192.168.1.110:3306)</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:36<span class="number"> 2019 </span>- [info] </span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:36<span class="number"> 2019 </span>- [info] * Phase 3.3: New Master Recovery Phase..</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:36<span class="number"> 2019 </span>- [info] </span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:36<span class="number"> 2019 </span>- [info]  Waiting all logs to be applied.. </span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:36<span class="number"> 2019 </span>- [info]   done.</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:36<span class="number"> 2019 </span>- [info] Getting new master's binlog name and position..</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:36<span class="number"> 2019 </span>- [info]  binlog.000004:3684</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:36<span class="number"> 2019 </span>- [info]  All other slaves should start replication from here. Statement should be: CHANGE MASTER TO MASTER_HOST='192.168.1.44', MASTER_PORT=3306, MASTER_AUTO_POSITION=1, MASTER_USER='repl', MASTER_PASSWORD='xxx';</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:36<span class="number"> 2019 </span>- [info] Master Recovery succeeded. File:Pos:Exec_Gtid_Set: binlog.000004, 3684, 8f9e146f-0a18-11e7-810a-0050568833c8:36,</span><br><span class="line">da15bfcd-663e-11e9-bd94-fa163e517ec6:1-3,</span><br><span class="line">e3b3cfbd-6666-11e9-be99-fa163e6bcf6d:1-49</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:36<span class="number"> 2019 </span>- [warning] master_ip_failover_script is not set. Skipping taking over new master IP address.</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:36<span class="number"> 2019 </span>- [info] Setting read_only=0 on 192.168.1.44(192.168.1.44:3306)..</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:36<span class="number"> 2019 </span>- [info]  ok.</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:36<span class="number"> 2019 </span>- [info] ** Finished master recovery successfully.</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:36<span class="number"> 2019 </span>- [info] * Phase 3: Master Recovery Phase completed.</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:36<span class="number"> 2019 </span>- [info] </span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:36<span class="number"> 2019 </span>- [info] * Phase 4: Slaves Recovery Phase..</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:36<span class="number"> 2019 </span>- [info] </span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:36<span class="number"> 2019 </span>- [info] </span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:36<span class="number"> 2019 </span>- [info] * Phase 4.1: Starting Slaves in parallel..</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:36<span class="number"> 2019 </span>- [info] </span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:36<span class="number"> 2019 </span>- [info] -- Slave recovery on host 192.168.1.110(192.168.1.110:3306) started, pid: 19912. Check tmp log /data/masterha/app1/192.168.1.110_3306_20190520164634.log if it takes time..</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:38<span class="number"> 2019 </span>- [info] </span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:38<span class="number"> 2019 </span>- [info] Log messages from 192.168.1.110 ...</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:38<span class="number"> 2019 </span>- [info] </span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:36<span class="number"> 2019 </span>- [info]  Resetting slave 192.168.1.110(192.168.1.110:3306) and starting replication from the new master 192.168.1.44(192.168.1.44:3306)..</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:36<span class="number"> 2019 </span>- [info]  Executed CHANGE MASTER.</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:37<span class="number"> 2019 </span>- [info]  Slave started.</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:37<span class="number"> 2019 </span>- [info]  gtid_wait(8f9e146f-0a18-11e7-810a-0050568833c8:36,</span><br><span class="line">da15bfcd-663e-11e9-bd94-fa163e517ec6:1-3,</span><br><span class="line">e3b3cfbd-6666-11e9-be99-fa163e6bcf6d:1-49) completed on 192.168.1.110(192.168.1.110:3306). Executed<span class="number"> 0 </span>events.</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:38<span class="number"> 2019 </span>- [info] End of log messages from 192.168.1.110.</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:38<span class="number"> 2019 </span>- [info] -- Slave on host 192.168.1.110(192.168.1.110:3306) started.</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:38<span class="number"> 2019 </span>- [info] All new slave servers recovered successfully.</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:38<span class="number"> 2019 </span>- [info] </span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:38<span class="number"> 2019 </span>- [info] * Phase 5: New master cleanup phase..</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:38<span class="number"> 2019 </span>- [info] </span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:38<span class="number"> 2019 </span>- [info] Resetting slave info on the new master..</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:38<span class="number"> 2019 </span>- [info]  192.168.1.44: Resetting slave info succeeded.</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:38<span class="number"> 2019 </span>- [info] Master failover to 192.168.1.44(192.168.1.44:3306) completed successfully.</span><br><span class="line">Mon May<span class="number"> 20 </span>16:46:38<span class="number"> 2019 </span>- [info] </span><br><span class="line"></span><br><span class="line">----- Failover Report --<span class="yaml"><span class="meta">---</span></span></span><br><span class="line"><span class="yaml"></span></span><br><span class="line"><span class="yaml"><span class="attr">app:</span> <span class="string">MySQL</span> <span class="string">Master</span> <span class="string">failover</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.115</span><span class="string">(192.168.1.115:3306)</span> <span class="string">to</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.44</span><span class="string">(192.168.1.44:3306)</span> <span class="string">succeeded</span></span></span><br><span class="line"><span class="yaml"></span></span><br><span class="line"><span class="yaml"><span class="string">Master</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.115</span><span class="string">(192.168.1.115:3306)</span> <span class="string">is</span> <span class="string">down!</span></span></span><br><span class="line"><span class="yaml"></span></span><br><span class="line"><span class="yaml"><span class="string">Check</span> <span class="string">MHA</span> <span class="string">Manager</span> <span class="string">logs</span> <span class="string">at</span> <span class="attr">ecs-3c90:/data/masterha/app1/manager.log</span> <span class="string">for</span> <span class="string">details.</span></span></span><br><span class="line"><span class="yaml"></span></span><br><span class="line"><span class="yaml"><span class="string">Started</span> <span class="string">automated(non-interactive)</span> <span class="string">failover.</span></span></span><br><span class="line"><span class="yaml"><span class="string">Selected</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.44</span><span class="string">(192.168.1.44:3306)</span> <span class="string">as</span> <span class="string">a</span> <span class="string">new</span> <span class="string">master.</span></span></span><br><span class="line"><span class="yaml"><span class="number">192.168</span><span class="number">.1</span><span class="number">.44</span><span class="string">(192.168.1.44:3306):</span> <span class="attr">OK:</span> <span class="string">Applying</span> <span class="string">all</span> <span class="string">logs</span> <span class="string">succeeded.</span></span></span><br><span class="line"><span class="yaml"><span class="number">192.168</span><span class="number">.1</span><span class="number">.110</span><span class="string">(192.168.1.110:3306):</span> <span class="attr">OK:</span> <span class="string">Slave</span> <span class="string">started,</span> <span class="string">replicating</span> <span class="string">from</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.44</span><span class="string">(192.168.1.44:3306)</span></span></span><br><span class="line"><span class="yaml"><span class="number">192.168</span><span class="number">.1</span><span class="number">.44</span><span class="string">(192.168.1.44:3306):</span> <span class="string">Resetting</span> <span class="string">slave</span> <span class="string">info</span> <span class="string">succeeded.</span></span></span><br><span class="line"><span class="yaml"><span class="string">Master</span> <span class="string">failover</span> <span class="string">to</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.44</span><span class="string">(192.168.1.44:3306)</span> <span class="string">completed</span> <span class="string">successfully.</span></span></span><br></pre></td></tr></table></figure>
<ul>
<li>MHA这里没有做高可用，生产环境MHA本身的单点故障也要考虑</li>
<li>最好不启用masterha_manager自动切换脚本，主要因为网络抖动（网线，所属机柜交换机不稳定）的情况下并不能保证数据真的不能访问，比如重启检测脚本所在机器的网卡并不能说明数据库出了问题，所以单点检测是不可靠的</li>
<li>可以通过consul集群的特性，增加多点检测机制，在n个集群环境中，有超过半数的检测点检测到数据库故障，才认为数据库不可访问，然后调研master_manager脚本进行切换</li>
</ul>
<blockquote>
<p>建议最好是手动的方式把故障的主库修复后再加入集群，过于自动的方式会有很多意想不到的错误。</p>
</blockquote>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>&emsp;&emsp;整体上而言, 使用 consul 的架构相对繁琐, 没有单节点那么简易方便, 不过对于比较核心的数据库来说, 一致性应该放到首位, 多点检测则很大程度上健壮了切换机制. 而且原工具自带的 masterha_manager 脚本本身只是循环检测, 超过三次错误(每次间隔时间递增)才会开始切换, 在网络波动, 交换机故障或数据库主机较繁忙的时候, 会引起一些意料之外的操作, 所以相对来说, 多点检测避免了这类不稳定的问题, 另外 consul cluster 部署完成后也可以用于其他需要一致性判断的业务, 不用太纠结于繁琐方面的考虑.</p>
</div><div class="tags"></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="http://www.timeser.com"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/DB/">DB</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/05/31/Consul-proxysql-MHA的MySQL高可用/">Consul+proxysql+MHA的MySQL高可用</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.gsandow.cn/" title="gsandow" target="_blank">gsandow</a><ul></ul><a href="http://www.github.com/timeless" title="github" target="_blank">github</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/." rel="nofollow">IT百晓生.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>